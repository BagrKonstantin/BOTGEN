{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Constructor</title>
    <style>
        #canvas {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
            position: relative;
            background: #f8f8f8;
        }
        .stage {
            padding: 10px;
            background: lightblue;
            border-radius: 5px;
            position: absolute;
            cursor: grab;
            min-width: 150px;
            text-align: center;
        }
        .options {
            margin-top: 10px;
            padding: 5px;
            background: white;
            border-radius: 5px;
        }
        .option {
            padding: 5px;
            margin: 3px 0;
            background: #ddd;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .settings-menu {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        .line {
            position: absolute;
            background: black;
            height: 2px;
            transform-origin: 0 0;
        }
        .button {
            cursor: pointer;
            padding: 3px 6px;
            border-radius: 3px;
            margin-left: 5px;
        }
        .add-option-btn { background: #4CAF50; color: white; border: none; }
        .delete-stage-btn { background: red; color: white; border: none; }
    </style>
</head>
<body>
<button id="add-stage-btn">Add Stage</button>
<div id="canvas"></div>

<div id="settings-menu" class="settings-menu"></div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        let canvas = document.getElementById("canvas");
        let addStageBtn = document.getElementById("add-stage-btn");
        let settingsMenu = document.getElementById("settings-menu");
        let stageCount = 0;
        let selectedOption = null;
        let optionTargetMap = new Map();
        let connections = new Map();

        addStageBtn.addEventListener("click", function() {
            stageCount++;
            let stage = document.createElement("div");
            stage.className = "stage";
            stage.innerText = "Stage " + stageCount;
            stage.style.top = Math.random() * 400 + "px";
            stage.style.left = Math.random() * 400 + "px";
            stage.setAttribute("draggable", true);
            stage.dataset.id = "stage-" + stageCount;

            let optionsContainer = document.createElement("div");
            optionsContainer.className = "options";
            optionsContainer.innerHTML = "<b>Options:</b>";

            let addOptionBtn = document.createElement("button");
            addOptionBtn.innerText = "Add Option";
            addOptionBtn.className = "add-option-btn";
            addOptionBtn.addEventListener("click", function() {
                let optionId = "option-" + Math.random().toString(36).substr(2, 9);
                let option = document.createElement("div");
                option.className = "option";
                option.innerText = "Option " + (optionsContainer.children.length);
                option.dataset.optionId = optionId;
                option.dataset.stageId = stage.dataset.id;

                let settingsBtn = document.createElement("button");
                settingsBtn.innerText = "âš™";
                settingsBtn.className = "button";
                settingsBtn.addEventListener("click", function(event) {
                    event.stopPropagation();
                    showSettingsMenu(event, option);
                });

                option.appendChild(settingsBtn);
                optionsContainer.appendChild(option);
            });

            let deleteStageBtn = document.createElement("button");
            deleteStageBtn.innerText = "Delete Stage";
            deleteStageBtn.className = "delete-stage-btn";
            deleteStageBtn.addEventListener("click", function(event) {
                event.stopPropagation();
                removeStage(stage);
            });

            stage.appendChild(optionsContainer);
            stage.appendChild(addOptionBtn);
            stage.appendChild(deleteStageBtn);
            canvas.appendChild(stage);

            stage.addEventListener("click", function() {
                if (selectedOption) {
                    setOptionTarget(selectedOption, stage);
                    selectedOption = null;
                }
            });

            stage.addEventListener("dragstart", (e) => {
                e.dataTransfer.setData("text/plain", e.target.dataset.id);
            });
        });

        canvas.addEventListener("dragover", function(event) {
            event.preventDefault();
        });

        canvas.addEventListener("drop", function(event) {
            event.preventDefault();
            let stageId = event.dataTransfer.getData("text/plain");
            let stage = document.querySelector(`[data-id='${stageId}']`);
            stage.style.top = `${event.clientY - 30}px`;
            stage.style.left = `${event.clientX - 50}px`;

            updateConnections();
        });

        function showSettingsMenu(event, option) {
            selectedOption = option;
            settingsMenu.innerHTML = `
                    <button onclick="setTarget()">Set Target</button>
                    <button onclick="deleteConnection()">Delete Connection</button>
                    <button onclick="removeOption()">Delete Option</button>
                `;
            settingsMenu.style.display = "block";
            settingsMenu.style.left = event.clientX + "px";
            settingsMenu.style.top = event.clientY + "px";

            document.addEventListener("click", closeMenu);
        }

        function closeMenu(event) {
            if (!settingsMenu.contains(event.target)) {
                settingsMenu.style.display = "none";
                document.removeEventListener("click", closeMenu);
            }
        }

        function setTarget() {
            if (selectedOption) {
                alert("Click on a stage to set the target");
            }
        }

        function setOptionTarget(option, stage) {
            optionTargetMap.set(option.dataset.optionId, stage.dataset.id);
            createConnection(option, stage);
            settingsMenu.style.display = "none";
        }

        function createConnection(option, toStage) {
            let fromStage = document.querySelector(`[data-id='${option.dataset.stageId}']`);
            let line = document.createElement("div");
            line.className = "line";
            canvas.appendChild(line);
            updateLine(line, option, toStage);

            connections.set(option.dataset.optionId, { line, fromStage, toStage });
        }

        function updateConnections() {
            connections.forEach((value, key) => {
                updateLine(value.line, value.fromStage.querySelector(`[data-option-id='${key}']`), value.toStage);
            });
        }

        function updateLine(line, option, toStage) {
            let optionRect = option.getBoundingClientRect();
            let toRect = toStage.getBoundingClientRect();
            let canvasRect = canvas.getBoundingClientRect();

            let startX = optionRect.left + optionRect.width / 2 - canvasRect.left;
            let startY = optionRect.top + optionRect.height / 2 - canvasRect.top;
            let endX = toRect.left + toRect.width / 2 - canvasRect.left;
            let endY = toRect.top + toRect.height / 2 - canvasRect.top;

            let dx = endX - startX;
            let dy = endY - startY;
            let distance = Math.sqrt(dx * dx + dy * dy);
            let angle = Math.atan2(dy, dx) * (180 / Math.PI);

            line.style.width = distance + "px";
            line.style.transform = `rotate(${angle}deg)`;
            line.style.left = startX + "px";
            line.style.top = startY + "px";
        }
    });
</script>
</body>
</html>
